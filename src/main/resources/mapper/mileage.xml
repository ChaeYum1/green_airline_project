<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.green.airline.repository.interfaces.MileageRepository">

	<!-- 마일리지 잔액 -->
	<select id="selectSaveMileage"
		resultType="com.green.airline.dto.SaveMileageDto">
		select sum(balance)as balance from mileage_tb where member_id =
		#{memberId} and now() &lt; expiration_date;
	</select>
	<!-- 소멸 마일리지 합 -->
	<select id="selectExtinctionMileage"
		resultType="com.green.airline.dto.SaveMileageDto">
		select sum(balance)as extinctionMileage from mileage_tb where member_id =
		#{memberId} and<![CDATA[  now() > expiration_date ]]>;
	</select>


	<!-- 사용한 마일리지 총 합 -->
	<select id="selectUseMileage"
		resultType="com.green.airline.dto.UseMileageDto">
		select sum(use_mileage) as use_mileage from mileage_tb where
		member_id = #{memberId};
	</select>






	<!-- 적립/사용 마일리지 리스트 조회 -->
	<select id="selectMileageList"
		resultType="com.green.airline.repository.model.Mileage">
		select * from mileage_tb;
	</select>
	

	<!-- 사용 마일리지 리스트 조회 -->
	<select id="selectUseMileageList"
		resultType="com.green.airline.repository.model.UseMileage">
		select * from mileage_tb where member_id = #{memberId} and use_date
		is not null;
	</select>

		<!-- 티켓 구매 시 마일리지 적립 -->
	<insert id="insertMileage">
		insert into
		mileage_tb(save_date,expiration_date,save_mileage,balance,member_id,ticket_id)
		values(#{departureDate},#{expirationDate},100,100,#{memberId},#{ticketId})
	</insert>
	
	<select id="selectNowMileage" resultType="com.green.airline.repository.model.Mileage">
	select * from mileage_tb  where member_id = #{memberId} 
	and expiration_date is not null and expiration_date > now() order by expiration_date asc;
	</select>
	<update id="updateBalance">
		update mileage_tb set balance = #{balance} where id = #{id};
	</update>
	
</mapper>

